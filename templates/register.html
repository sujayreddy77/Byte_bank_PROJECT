{% extends "layout.html" %}
{% block title %}Register - ByteBank{% endblock %}

{% block content %}
<h2 class="page-title">Create an Account</h2>

<div class="card auth-card">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Full Name -->
  <div class="form-group">
    <label>Full Name</label>
    <input type="text" id="name" placeholder="Enter your full name" autocomplete="off">
  </div>

  <!-- Identifier -->
  <div class="form-group">
    <label>Email or Mobile</label>
    <input type="text" id="identifier" placeholder="Enter your email or mobile" autocomplete="off">
  </div>

  <!-- Password -->
  <div class="form-group password-wrapper">
    <label>Password</label>
    <input type="password" id="password" placeholder="Create a password" autocomplete="new-password">
    <span class="toggle-password" onclick="togglePassword('password', this)">üëÅ</span>
  </div>

  <!-- OTP Field -->
  <div class="form-group" id="otp-group" style="display:none;">
    <label>OTP</label>
    <input type="text" id="otp" placeholder="Enter OTP">
  </div>

  <!-- Buttons -->
  <div class="controls">
    <button id="send-otp-btn" class="btn btn-primary">Send OTP</button>
    <button id="register-btn" class="btn btn-success" style="display:none;">Complete Registration</button>
  </div>

  <!-- Login Link -->
  <div class="meta">
    Already have an account?  
    <a href="{{ url_for('login_page') }}">Login here</a>
  </div>

  <div id="msg" class="msg"></div>

</div>
{% endblock %}

{% block css %}
<style>
.page-title {
  text-align: center;
  margin-bottom: 20px;
}

/* Main card */
.auth-card {
  width: 80%;
  margin: auto;
  padding: 25px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}

/* Flash messages */
.flash {
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
}
.flash.success { background: #d4edda; color: #155724; }
.flash.error { background: #f8d7da; color: #721c24; }

/* Form */
.form-group {
  margin-bottom: 15px;
}
.form-group label {
  font-weight: 600;
  font-size: 0.95rem;
}
.form-group input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 6px;
}

/* Password toggle */
.password-wrapper {
  position: relative;
}
.toggle-password {
  position: absolute;
  right: 12px;
  top: 42px;
  cursor: pointer;
  font-size: 18px;
}

/* Buttons */
.btn {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  font-weight: 600;
  border: none;
  margin-bottom: 8px;
}
.btn-primary { background: #007bff; color: white; }
.btn-success { background: #28a745; color: white; }

/* Meta */
.meta {
  text-align: center;
  margin-top: 12px;
  font-size: 0.9rem;
}
.meta a {
  color: #007bff;
  text-decoration: none;
}
.meta a:hover {
  text-decoration: underline;
}

/* Message line */
.msg {
  margin-top: 12px;
  text-align: center;
  color: #d9534f;
  font-size: 0.9rem;
}
</style>
{% endblock %}

{% block js %}
<script>

// Toggle password visibility
function togglePassword(id, el) {
  const input = document.getElementById(id);
  input.type = input.type === "password" ? "text" : "password";
}

// Show message
function showMsg(text, timeout=4000) {
  const msg = document.getElementById("msg");
  msg.textContent = text;
  if (timeout) setTimeout(()=> msg.textContent = "", timeout);
}

// Build payload for email/mobile
function identifierPayload(identifier) {
  let payload = {};
  if (identifier.includes("@")) payload.email = identifier;
  else payload.mobile = identifier.replace(/\s+/g, "").replace(/^\+/, "");
  return payload;
}

const nameInput = document.getElementById("name");
const identifierInput = document.getElementById("identifier");
const passwordInput = document.getElementById("password");
const otpInput = document.getElementById("otp");
const otpGroup = document.getElementById("otp-group");
const sendBtn = document.getElementById("send-otp-btn");
const registerBtn = document.getElementById("register-btn");

// SEND OTP
sendBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  const identifier = identifierInput.value.trim();
  const pwd = passwordInput.value.trim();

  if (!name || !identifier || !pwd) {
    showMsg("Fill all fields first");
    return;
  }

  sendBtn.disabled = true;
  showMsg("Sending OTP...");

  const payload = Object.assign(identifierPayload(identifier), { purpose: "register" });

  try {
    const res = await fetch("/api/send_otp", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    showMsg(data.message);

    if (data.success) {
      otpGroup.style.display = "block";
      registerBtn.style.display = "block";
      identifierInput.disabled = true;
    }

  } catch (e) {
    showMsg("Server error. Try again.");
  }

  sendBtn.disabled = false;
});

// COMPLETE REGISTRATION
registerBtn.addEventListener("click", async () => {
  const identifier = identifierInput.value.trim();
  const name = nameInput.value.trim();
  const pwd = passwordInput.value.trim();
  const otp = otpInput.value.trim();

  if (!otp) {
    showMsg("Enter OTP");
    return;
  }

  showMsg("Verifying OTP...");

  const verifyPayload = Object.assign(identifierPayload(identifier), { otp, purpose: "register" });

  const vRes = await fetch("/api/verify_otp", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(verifyPayload)
  });
  const v = await vRes.json();

  if (!v.success) {
    showMsg(v.message);
    return;
  }

  showMsg("OTP verified. Creating account...");

  // Now register user
  const regPayload = Object.assign(identifierPayload(identifier), { name, password: pwd });

  const rRes = await fetch("/api/register", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(regPayload)
  });
  const r = await rRes.json();
  showMsg(r.message);

  if (r.success) {
    setTimeout(()=> window.location.href="/dashboard", 700);
  }
});

</script>
{% endblock %}