{% extends "layout.html" %}
{% block title %}Login - ByteBank{% endblock %}

{% block content %}
<h2 class="page-title">Login</h2>

<div class="card auth-card">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Email/Mobile -->
  <div class="form-group">
    <label>Email or Mobile</label>
    <input type="text" id="identifier" placeholder="Enter your email or mobile" autocomplete="off">
  </div>

  <!-- Password -->
  <div class="form-group password-wrapper">
    <label>Password</label>
    <input type="password" id="password" placeholder="Enter your password" autocomplete="new-password">
    <span class="toggle-password" onclick="togglePassword('password', this)">üëÅ</span>
  </div>

  <!-- Login Button -->
  <button id="login-btn" class="btn btn-primary">Login</button>

  <!-- Links -->
  <div class="meta meta-row">
      <a class="meta-link meta-register" href="{{ url_for('register_page') }}">
        Create Account
      </a>

      <a class="meta-link meta-forgot" href="{{ url_for('forgot') }}">
        Forgot Password?
      </a>
  </div>

  <div id="msg" class="msg"></div>
</div>
{% endblock %}


{% block css %}
<style>
.page-title {
  text-align: center;
  margin-bottom: 20px;
  color: #007bff;
  font-weight: 700;
}

.auth-card {
  width: 80%;
  margin: auto;
  padding: 25px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
}

/* Flash messages */
.flash {
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
}
.flash.success { background: #d4edda; color: #155724; }
.flash.error { background: #f8d7da; color: #721c24; }

/* Form inputs */
.form-group { margin-bottom: 15px; }
.form-group label { font-weight: 600; font-size: 0.95rem; }
.form-group input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 6px;
}

/* Password visibility */
.password-wrapper {
  position: relative;
}
.toggle-password {
  position: absolute;
  right: 12px;
  top: 42px;
  cursor: pointer;
  font-size: 18px;
  opacity: 0.6;
}
.toggle-password:hover { opacity: 1; }

/* Buttons */
.btn {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  font-weight: 600;
  margin-top: 12px;
  border: none;
}
.btn-primary {
  background: #007bff;
  color: white;
}

/* Links layout */
.meta-row {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 14px;
  flex-wrap: wrap;
}

.meta-link {
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  font-size: 0.95rem;
}

.meta-register {
  color: #007bff;
  border: 1px solid rgba(0,123,255,0.15);
}

.meta-forgot {
  color: #6c757d;
  border: 1px solid rgba(108,117,125,0.15);
}

.meta-link:hover {
  filter: brightness(0.95);
  transform: translateY(-1px);
}

/* Error message */
.msg {
  margin-top: 10px;
  color: #d9534f;
  text-align: center;
}

/* Responsive */
@media (max-width: 520px) {
  .meta-row { flex-direction: column; }
  .meta-link { width: 100%; text-align: center; }
}
</style>
{% endblock %}


{% block js %}
<script>

// Build email/mobile object
function getIdentifierPayload(identifier) {
    let payload = {};
    if (identifier.includes("@")) payload.email = identifier;
    else payload.mobile = identifier.replace(/\s+/g, "").replace(/^\+/, "");
    return payload;
}

// Toggle password visibility
function togglePassword(id, el) {
  const input = document.getElementById(id);
  input.type = input.type === "password" ? "text" : "password";
}

const msg = document.getElementById("msg");

// LOGIN
document.getElementById("login-btn").addEventListener("click", async () => {
    const identifier = document.getElementById("identifier").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!identifier || !password) {
        msg.textContent = "Both fields required.";
        return;
    }

    const payload = getIdentifierPayload(identifier);
    payload.password = password;

    const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    msg.textContent = data.message || "";

    if (data.success) {
        setTimeout(() => window.location.href = "/dashboard", 600);
    }
});
</script>
{% endblock %}