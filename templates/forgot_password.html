{% extends "layout.html" %}
{% block title %}Forgot Password - ByteBank{% endblock %}

{% block content %}

<h2 class="page-title">Forgot Password</h2>

<div class="card auth-card">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ============ STEP 1 ============ -->
  {% if step == 1 %}
  <form method="POST">

    <div class="form-group">
      <label>Email or Mobile</label>
      <input type="text" name="identifier" placeholder="Enter email or mobile" required>
    </div>

    <button class="btn btn-primary">Send OTP</button>

    <a href="{{ url_for('login_page') }}" class="back-link">‚Üê Back to Login</a>
  </form>
  {% endif %}

  <!-- ============ STEP 2 ============ -->
  {% if step == 2 %}
  <form method="POST">

    <p class="info-text">OTP sent to <b>{{ identifier }}</b></p>

    <div class="form-group">
      <label>Enter OTP</label>
      <input type="text" name="otp" placeholder="Enter OTP" required>
    </div>

    <button class="btn btn-primary">Verify OTP</button>

    <button type="button" id="resendBtn" class="btn btn-secondary" disabled>
      Resend OTP (30s)
    </button>

    <a href="{{ url_for('forgot_password') }}" class="back-link">‚Üê Back</a>

  </form>
  {% endif %}

  <!-- ============ STEP 3 ============ -->
  {% if step == 3 %}
  <form method="POST">

    <div class="form-group password-group">
      <label>New Password</label>
      <input type="password" id="new_password" name="new_password" required>
      <span class="toggle-password" onclick="togglePass('new_password', this)">üëÅÔ∏è</span>
    </div>

    <div class="form-group password-group">
      <label>Confirm Password</label>
      <input type="password" id="confirm_password" name="confirm_password" required>
      <span class="toggle-password" onclick="togglePass('confirm_password', this)">üëÅÔ∏è</span>
    </div>

    <button class="btn btn-primary">Reset Password</button>

    <a href="{{ url_for('login_page') }}" class="back-link">‚Üê Back to Login</a>

  </form>
  {% endif %}

</div>

{% endblock %}

{% block css %}
<style>
.page-title{text-align:center;margin-bottom:20px;font-size:1.8rem;color:#007bff;font-weight:600;}

.auth-card{
  width:80%;margin:auto;padding:25px;background:#fff;border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,0.08);
}

.form-group{margin-bottom:15px;}
.form-group input{
  width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;
}

.btn{
  width:100%;padding:12px;border-radius:8px;margin-top:10px;font-weight:600;border:none;
}
.btn-primary{background:#007bff;color:white;}
.btn-secondary{background:#6c757d;color:white;}

.back-link{
  display:block;text-align:center;margin-top:15px;color:#6c757d;
}

.flash{padding:10px;border-radius:8px;margin-bottom:12px;text-align:center;}
.flash.error{background:#f8d7da;color:#721c24;}
.flash.success{background:#d4edda;color:#155724;}

.password-group{position:relative;}
.password-group input{padding-right:40px;}
.toggle-password{
  position:absolute;right:10px;top:38px;cursor:pointer;color:#666;
}
.toggle-password:hover{color:#007bff;}

.info-text{text-align:center;margin-bottom:12px;}
</style>
{% endblock %}

{% block js %}
<script>
function togglePass(id, el){
  const input = document.getElementById(id);
  if(input.type === "password"){
    input.type = "text";
    el.textContent = "üôà";
  } else {
    input.type = "password";
    el.textContent = "üëÅÔ∏è";
  }
}

{% if step == 2 %}

// -----------------------------
// OTP RESEND TIMER FIXED
// -----------------------------
let seconds = 30;
let btn = document.getElementById("resendBtn");

let timer = setInterval(() => {
  btn.textContent = Resend OTP (${seconds}s);
    seconds--;
  if(seconds < 0){
        clearInterval(timer);
    btn.disabled = false;
    btn.textContent = "Resend OTP";
    }
}, 1000);

// -----------------------------
// RESEND OTP CLICK FIXED
// -----------------------------
btn.addEventListener("click", () => {
  btn.disabled = true;
    seconds = 30;

    fetch("/api/send_otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            {% if '@' in identifier %}
            email: "{{ identifier }}",
            {% else %}
            mobile: "{{ identifier }}",
            {% endif %}
            purpose: "reset"
        })
    });

    let timer2 = setInterval(() => {
    btn.textContent = Resend OTP (${seconds}s);
        seconds--;
    if(seconds < 0){
            clearInterval(timer2);
      btn.disabled = false;
      btn.textContent = "Resend OTP";
        }
    }, 1000);
});

{% endif %}
</script>
{% endblock %}